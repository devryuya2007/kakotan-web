# ãƒªãƒªãƒ¼ã‚¹è‡ªå‹•åŒ–ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# v* ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã‚¿ã‚°ãŒãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸã‚‰è‡ªå‹•ã§ãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹
name: Create Release

on:
  push:
    tags:
      - "v*"  # v1.0.0, v2.3.1 ãªã©ã®ã‚¿ã‚°ã«ãƒãƒƒãƒ

# GitHub Releaseã®ä½œæˆã«å¿…è¦ãªæ¨©é™
permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      # ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆï¼ˆå…¨å±¥æ­´ã‚’å–å¾—ã—ã¦ã‚¿ã‚°æ¯”è¼ƒã‚’å¯èƒ½ã«ã™ã‚‹ï¼‰
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          # å…¨å±¥æ­´ã‚’å–å¾—ï¼ˆå‰å›ã‚¿ã‚°ã¨ã®å·®åˆ†ã‚’å–ã‚‹ãŸã‚ï¼‰
          fetch-depth: 0

      # Node.js 20ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: main/package-lock.json

      # ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: |
          cd main
          npm ci

      # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ“ãƒ«ãƒ‰
      - name: Build project
        run: |
          cd main
          npm run build

      # ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ZIPãƒ•ã‚¡ã‚¤ãƒ«ã«åœ§ç¸®
      - name: Create ZIP file
        run: |
          cd main/dist
          zip -r ../../kakotan-web-${{ github.ref_name }}.zip .
          cd ../..

      # ã‚«ãƒ†ã‚´ãƒªåˆ†ã‘ã•ã‚ŒãŸãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’è‡ªå‹•ç”Ÿæˆ
      - name: Generate categorized release notes
        id: release_notes
        run: |
          # å‰å›ã®ã‚¿ã‚°ã‚’å–å¾—ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã¯ç©ºæ–‡å­—ï¼‰
          PREVIOUS_TAG=$(git rev-list --tags --skip=1 --max-count=1 \
            2>/dev/null | xargs -r git describe --tags --abbrev=0 \
            2>/dev/null || echo "")

          if [ -z "$PREVIOUS_TAG" ]; then
            # åˆå›ãƒªãƒªãƒ¼ã‚¹ã®å ´åˆ
            NOTES="## ğŸ‰ åˆå›ãƒªãƒªãƒ¼ã‚¹\n\n"
            NOTES+="å…±é€šãƒ†ã‚¹ãƒˆéå»å•ç‰¹åŒ–ã®è‹±å˜èªã‚¢ãƒ—ãƒª"
          else
            # 2å›ç›®ä»¥é™ã®ãƒªãƒªãƒ¼ã‚¹ï¼šå‰å›ã‚¿ã‚°ã‹ã‚‰ã®å¤‰æ›´å†…å®¹ã‚’æŠ½å‡º
            NOTES="## ğŸ“ å¤‰æ›´å†…å®¹ "
            NOTES+="($PREVIOUS_TAG â†’ ${{ github.ref_name }})\n\n"

            # feat: ã§å§‹ã¾ã‚‹ã‚³ãƒŸãƒƒãƒˆã‚’æ–°æ©Ÿèƒ½ã¨ã—ã¦æŠ½å‡º
            FEATURES=$(git log ${PREVIOUS_TAG}..HEAD \
              --pretty=format:"%s" --grep="^feat:" --no-merges)
            if [ -n "$FEATURES" ]; then
              NOTES+="### âœ¨ æ–°æ©Ÿèƒ½\n"
              while IFS= read -r line; do
                NOTES+="- $line\n"
              done <<< "$FEATURES"
              NOTES+="\n"
            fi

            # fix: ã§å§‹ã¾ã‚‹ã‚³ãƒŸãƒƒãƒˆã‚’ãƒã‚°ä¿®æ­£ã¨ã—ã¦æŠ½å‡º
            FIXES=$(git log ${PREVIOUS_TAG}..HEAD \
              --pretty=format:"%s" --grep="^fix:" --no-merges)
            if [ -n "$FIXES" ]; then
              NOTES+="### ğŸ› ãƒã‚°ä¿®æ­£\n"
              while IFS= read -r line; do
                NOTES+="- $line\n"
              done <<< "$FIXES"
              NOTES+="\n"
            fi

            # chore, refactor, docs, test ã§å§‹ã¾ã‚‹ã‚³ãƒŸãƒƒãƒˆã‚’
            # ãã®ä»–ã®å¤‰æ›´ã¨ã—ã¦æŠ½å‡º
            OTHERS=$(git log ${PREVIOUS_TAG}..HEAD \
              --pretty=format:"%s" \
              --grep="^chore:" --grep="^refactor:" \
              --grep="^docs:" --grep="^test:" --no-merges)
            if [ -n "$OTHERS" ]; then
              NOTES+="### ğŸ”§ ãã®ä»–ã®å¤‰æ›´\n"
              while IFS= read -r line; do
                NOTES+="- $line\n"
              done <<< "$OTHERS"
            fi
          fi

          # ç”Ÿæˆã—ãŸãƒãƒ¼ãƒˆã‚’GitHub Outputã«ä¿å­˜
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo -e "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # GitHub Releaseã‚’ä½œæˆã—ã¦å…¬é–‹
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ github.ref_name }}
          body: |
            ${{ steps.release_notes.outputs.notes }}

            ---

            ## ğŸ“¦ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

            ä¸‹è¨˜ã®ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦å±•é–‹å¾Œã€
            Webã‚µãƒ¼ãƒãƒ¼ã§å…¬é–‹ã—ã¦ãã ã•ã„ã€‚

            ## ğŸš€ ä½¿ã„æ–¹

            ```bash
            unzip kakotan-web-${{ github.ref_name }}.zip -d kakotan-web
            cd kakotan-web
            # Webã‚µãƒ¼ãƒãƒ¼ã§å…¬é–‹
            ```
          files: |
            kakotan-web-${{ github.ref_name }}.zip
          draft: false
          prerelease: false
          # GitHubæ¨™æº–ã®ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚‚ä½µç”¨
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
